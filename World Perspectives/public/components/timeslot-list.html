<link rel="import" href="/bower_components/polymer/polymer.html" />
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html" />
<link rel="import" href="/bower_components/iron-icons/iron-icons.html" />
<link rel="import" href="/bower_components/paper-material/paper-material.html" />
<link rel="import" href="/bower_components/paper-item/paper-item.html" />
<link rel="import" href="/bower_components/paper-dialog/paper-dialog.html" />
<link rel="import" href="/bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html" />
<link rel="import" href="/bower_components/paper-ripple/paper-ripple.html" />
<link rel="import" href="/bower_components/paper-toast/paper-toast.html" />
<script src="/socket.io/socket.io.js"></script>

<dom-module id="timeslot-list">
	<style>
		paper-item {
			margin-top: 5px;
			margin-bottom: 5px;
			padding-top: 10px;
			padding-bottom: 10px;
			cursor: pointer;
			-webkit-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
			--paper-item-focused-before: {
				opacity: 0;
			}
		}
		paper-item > span, paper-item > .button-content > span {
			color: #555;
			width: 24px;
			text-align: center;
			margin-right: 10px;
			font-size: 1.4em;
			font-weight: bold;
		}

			paper-item > span core-icon, paper-item > .button-content > span core-icon {
				position: relative;
				top: -1px;
				left: -3px;
			}

		paper-item h2 {
			margin: 0;
			text-align: left;
			font-size: 1.4em;
		}
		paper-item h2 > small {
			color: #4F4F4F;
			font-weight: lighter;
			font-size: 75%;
			display: block;
			text-decoration: none !important;
		}
			paper-item h2 > small > .session-type {
				font-weight: bold;
			}
			paper-item h2 > small > .panelist::after {
				content: ",";
			}
			paper-item h2 > small > .panelist:last-of-type::after {
				content: "";
			}

		:host > p {
			font-size: 1.2em;
			margin-bottom: 0.5em;
			margin-top: 0;
		}

		paper-dialog {
			width: 80%;
			text-align: left;
		}
			paper-dialog h1 {
				font-size: 2em;
			}
				paper-dialog h1 small {
					float: left;
					opacity: 0.65;
					font-size: 60%;
					margin: 5px 0;
				}
		paper-dialog-scrollable {
			font-size: 1.1em;
			clear: both;
		}
		paper-dialog paper-button[dialog-dismiss] {
			color: black;
		}

		.flex-container {
			padding-top: 5px;
			@apply(--layout-horizontal);
		}
		.flex {
			@apply(--layout-flex);
		}
		.fade {
			opacity: 0.6;
		}
		.line-breaks {
			white-space: pre-line;
		}

		/* Mobile styles */
		@media screen and (max-width: 35.5em) {
			paper-item > span {
				display: none;
			}

			paper-item {
				width: auto;
			}
		}
	</style>
	<template>
		<iron-ajax id="user-ajax" auto url="/user" handle-as="json" last-response="{{user}}" on-error="handleError" params="{{userListParams}}"></iron-ajax>
		<iron-ajax id="get-sessions-ajax" auto url="{{url}}" last-response="{{sessions}}" handle-as="json"></iron-ajax>
		<!--<iron-ajax id="postSession" method="POST" url="{{url}}" on-core-response="finishSelection" on-core-error="handleError" handle-as="json"></iron-ajax>-->
		<p>Please choose a panel, global studies session, or science session to fill the <b>[[start.formatted]]</b> to <b>[[end.formatted]]</b> period</p>
		<div id="itemcontainer">
			<template is="dom-if" if="[[!sessions.length]]">
				<p style="font-size: 1.4em;">Loading...</p>
			</template>
			<template is="dom-repeat" items="[[sessions]]" as="session">
				<paper-item on-click="showDetails" slug="[[session.title.slug]]">
					<paper-ripple></paper-ripple>
					<span><iron-icon icon="radio-button-unchecked"></iron-icon></span>
					<h2>
						<span>[[session.title.formatted]]</span>
						<template is="dom-if" if="[[session.moderator]]">
							<small>
								<span class="session-type">Panel</span> –
								<template is="dom-repeat" items="[[session.presenters]]" as="presenter">
									<span class="panelist">[[presenter.name]]</span>
								</template>
							</small>
						</template>
						<template is="dom-if" if="[[!session.moderator]]">
							<small>
								<template is="dom-if" if="[[_ifGlobalSession(session)]]">
									<span class="session-type">Global Session</span> –
								</template>
								<template is="dom-if" if="[[!_ifGlobalSession(session)]]">
									<span class="session-type">Science Session</span> –
								</template>
								<template is="dom-repeat" items="[[session.presenters]]" as="presenter">
									<!-- There should only be one presenter but this repeat destructures the array and future-proofs -->
									<span>[[presenter.name]]</span>
								</template>
							</small>
						</template>
					</h2>
				</paper-item>
			</template>
		</div>
		<paper-dialog id="session-detail" entry-animation="fade-in-animation" exit-animation="fade-out-animation" with-backdrop>
			<div class="flex-container" style="max-height: 80px;">
				<h1>
					<span>[[selectedSession.title.formatted]]</span>
					<br />
					<small>[[selectedSession.time.start.formatted]] to [[selectedSession.time.end.formatted]] — [[selectedSession.location]] ([[selectedSession.capacity.filled]] / [[selectedSession.capacity.total]])</small>
				</h1>
			</div>
			<paper-dialog-scrollable class="line-breaks" style="margin-top: 0">
				[[selectedSession.description]]
			</paper-dialog-scrollable>
			<p>
				<!-- For panels -->
				<template is="dom-if" if="[[selectedSession.isPanel]]">
					<b>Panelists:</b>
					[[selectedSession.presentersString]]
					<br />
					<b>Moderator:</b>
					[[selectedSession.moderatorString]]
				</template>
				<!-- For regular sessions -->
				<template is="dom-if" if="[[!selectedSession.isPanel]]">
					<b>Presenter:</b>
					[[selectedSession.presentersString]]
				</template>
			</p>
			<div class="buttons">
				<paper-button dialog-dismiss>Close</paper-button>
				<paper-button dialog-dismiss style="color: #4285f4;">Select</paper-button>
			</div>
		</paper-dialog>
	</template>
	<script>
		Polymer({
			is: "timeslot-list",
			properties: {
				index: {
					type: String,
					value: "0",
					notify: true
				},
				url: {
					type: String,
					notify: true
				},
				start: {
					type: Object,
					notify: true
				},
				end: {
					type: Object,
					notify: true
				},
				selectedSession: {
					type: Object,
					value: function () {
						return {};
					}
				},
				previousSelectedSession: {
					type: Object,
					value: function () {
						return {};
					}
				}
			},
			_ifGlobalSession: function (session) {
				return session.type == "Global session";
			},
			/*
			created: function () {
				this.sessions = [];
				this.sessionsLookup = {};
				this.selectedSession = null;
				this.previousSelectedSession = null;
				this.forwardButton = null;
				this.checkmark = '<core-icon icon="radio-button-on"></core-icon>';
				this.dash = '<core-icon icon="radio-button-off"></core-icon>';
				this.startTimeFormat = null;
				this.endTimeFormat = null;
			},
			*/
			ready: function () {
				// WebSocket connection to update session availability in real-time
				var socket = io.connect("/");
				socket.on("availability", function (data) {
					/*if (this.sessionsLookup[data.session]) {
						// Relevent to this session-list
						this.sessionsLookup[data.session].capacity.taken = data.taken;
						// Update any open dialog's data
						if (this.selectedSession && this.selectedSession.id === data.session) {
							this.selectedSession.capacity.taken = data.taken;
						}
					}*/
				}.bind(this));
				//this.forwardButton = Polymer.dom(this.parentElement).querySelector("paper-button#" + "forward-" + this.index);
				// Polyfill until ES6 is widely supported
				if (!Array.prototype.find) {
					Array.prototype.find = function (predicate) {
						if (this === null) {
							throw new TypeError('Array.prototype.find called on null or undefined');
						}
						if (typeof predicate !== 'function') {
							throw new TypeError('predicate must be a function');
						}
						var list = Object(this);
						var length = list.length >>> 0;
						var thisArg = arguments[1];
						var value;

						for (var i = 0; i < length; i++) {
							value = list[i];
							if (predicate.call(thisArg, value, i, list)) {
								return value;
							}
						}
						return undefined;
					};
				}
			},
			loaded: function () {
				// Make a copy of the loaded data
				//this.sessions = this.$.getSessions.response.sessions.slice(0);
				//this.startTimeFormat = this.$.getSessions.response.start;
				//this.endTimeFormat = this.$.getSessions.response.end;
				//for (var i = 0, len = this.sessions.length; i < len; i++) {
					//this.set("sessionsLookup" + ("." + this.sessions[i].id), this.sessions[i]);
				//}
			},
			showDetails: function (e) {
				var slug = e.currentTarget.slug;
				this.previousSelectedSession = this.selectedSession;
				this.selectedSession = this.sessions.find(function (session) {
					return session.title.slug === slug;
				});
				if (!this.selectedSession)
					return;
				this.selectedSession.presentersString = this.selectedSession.presenters.map(function (presenter) {
					return presenter.name;
				}).join(", ");
				this.selectedSession.isPanel = !!this.selectedSession.moderator;
				if (this.selectedSession.moderator) {
					this.selectedSession.moderatorString = this.selectedSession.moderator.name;
				}
				// Don't ask me why this hack is necessary
				// I think it has something to do with the fact that Polymer doesn't think adding properties consists of an update to the object
				var temp = this.selectedSession;
				this.selectedSession = {};
				this.selectedSession = temp;

				this.$["session-detail"].open();
			},
			dialogButtonHandler: function (e) {
				var initiatorAction = e.currentTarget.attributes.type.value;
				this.$.details.close();
				var uponDialogClose = function () {
					document.removeEventListener("core-overlay-close-completed", uponDialogClose);
					if (initiatorAction === "select") {
						// Register this with the server
						var sendData = { "session": this.selectedSession.id };
						this.$.postSession.params = JSON.stringify(sendData);
						this.$.postSession.go();
						// Show a loading indicator
						window.loadingToast.show();
					}
				};
				uponDialogClose = uponDialogClose.bind(this);
				document.addEventListener("core-overlay-close-completed", uponDialogClose);
			},
			finishSelection: function () {
				console.timeEnd("Session selection");
				window.loadingToast.dismiss();
				switch (this.startTimeFormat) {
					case "9:00 AM":
						window.selections.first = this.selectedSession;
						break;
					case "9:55 AM":
						window.selections.second = this.selectedSession;
						break;
					case "11:30 AM":
						window.selections.third = this.selectedSession;
						break;
					case "12:25 PM":
						window.selections.fourth = this.selectedSession;
						break;
					case "1:20 PM":
						window.selections.fifth = this.selectedSession;
						break;
				}
				// Unselect the previous choice
				if (this.previousSelectedSession) {
					Polymer.dom(Polymer.dom(this.$.itemcontainer).querySelector("#id" + this.previousSelectedSession.id + " span")).innerHTML = this.dash;
				}
				// Turn the item's dash into a checkmark
				Polymer.dom(Polymer.dom(this.$.itemcontainer).querySelector("#id" + this.selectedSession.id + " span")).innerHTML = this.checkmark;
				// Dim the other items
				var titles = Polymer.dom(this.$.itemcontainer).querySelectorAll("h2");
				for (var i = 0; i < titles.length; i++) {
					titles[i].style.opacity = "0.5";
				}
				Polymer.dom(this.$.itemcontainer).querySelector("#id" + this.selectedSession.id + " h2").style.opacity = "1";
				// Proceed
				Polymer.dom(this.forwardButton).removeAttribute("disabled");
				// Dirty hack for visual glitch in Google Chrome
				setTimeout(function () {
					this.forwardButton.click();
				}.bind(this), 1);
			},
			handleError: function (e) {
				window.loadingToast.dismiss();
				window.notifierToast.text = e.detail.response.response.error || "An error occurred!";
				window.notifierToast.show();
				// Failed requests will still deregister any previous registrations for that session type
				// Unselect the previous choice
				if (this.previousSelectedSession) {
					Polymer.dom(Polymer.dom(this.$.itemcontainer).querySelector("#id" + this.previousSelectedSession.id + " span")).innerHTML = this.dash;
				}
				// Undim all other items
				var titles = Polymer.dom(this.$.itemcontainer).querySelectorAll("h2");
				for (var i = 0; i < titles.length; i++) {
					titles[i].style.opacity = "1";
				}
			}
		});
	</script>
</dom-module>